<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TV Repair — Submit</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://api.ipify.org">
  
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #fafafa;
      color: #222;
      padding: 18px;
      line-height: 1.5;
    }
    
    form {
      max-width: 640px;
      margin: 18px auto;
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    
    label {
      display: block;
      margin: 16px 0 6px;
      font-weight: 600;
    }
    
    input, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    button {
      margin-top: 20px;
      padding: 12px 20px;
      border: none;
      background: #1976d2;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #1565c0;
    }
    
    pre {
      max-width: 640px;
      margin: 18px auto;
      background: #111;
      color: #fff;
      padding: 16px;
      border-radius: 6px;
      overflow: auto;
      white-space: pre-wrap;
      font-size: 14px;
    }
    
    .ok {
      color: #4caf50;
    }
    
    .err {
      color: #f44336;
    }
    
    .form-header {
      text-align: center;
      margin-bottom: 24px;
      color: #1976d2;
    }
    
    .required::after {
      content: " *";
      color: #f44336;
    }
  </style>
</head>
<body>
  <form id="repairForm" autocomplete="off">
    <h2 class="form-header">TV Repair Request</h2>
    
    <input type="hidden" name="formType" value="tv">

    <label for="name" class="required">Name</label>
    <input id="name" name="name" required placeholder="Your full name">

    <label for="phone" class="required">Phone</label>
    <input id="phone" name="phone" required placeholder="Your phone number">

    <label for="tv_type">TV Type</label>
    <input id="tv_type" name="tv_type" placeholder="Brand and model of your TV">

    <label for="issue">Issue Description</label>
    <textarea id="issue" name="issue" rows="4" placeholder="Describe the problem with your TV"></textarea>

    <button type="submit">Submit Repair Request</button>
  </form>

  <pre id="result">Ready to submit your repair request</pre>

  <script>
    // ========== CONFIGURATION ==========
    const SHEETS_URL = "https://script.google.com/macros/s/AKfycbx12WDAXTee5MTo8cCMHU-8ML7NeMDAqno355yDPnVFdWROjJhDnjDzLI58M7tqWnUvpg/exec";
    const EMAIL_URL  = "https://script.google.com/macros/s/AKfycbxT6qDnlNTsBKm3Va-qCAB836YpvOPaQR87dLNBGOnelbY7jws6Gmc6wzLzeYKIcmGsrg/exec";
    const GCLID_URL  = "https://script.google.com/macros/s/AKfycbxsS9iNSD9lHeuRrJmO9r70rsLBsKIwVGmP7Aqpap-xycgVSi9VKSO8u1_HyXQvlpM-/exec";
    // ===================================

    // DOM Elements
    const form = document.getElementById('repairForm');
    const resultDisplay = document.getElementById('result');

    // Initialize GCLID tracking if present
    initializeGclidTracking();

    // ========== HELPER FUNCTIONS ==========
    
    function setResult(text, isSuccess) {
      resultDisplay.textContent = text;
      resultDisplay.className = isSuccess ? 'ok' : 'err';
    }

    function formDataToObject(formData) {
      const obj = {};
      for (const [key, value] of formData.entries()) {
        obj[key] = value;
      }
      return obj;
    }

    function normalizePhone(phoneString) {
      return (phoneString || '').toString().replace(/\D/g, '');
    }

    function tryParseJSON(text) {
      try {
        return JSON.parse(text);
      } catch (error) {
        return text;
      }
    }

    // ========== GCLID TRACKING ==========
    
    function initializeGclidTracking() {
      const gclid = new URLSearchParams(window.location.search).get("gclid");
      if (gclid) {
        // Defer execution to avoid blocking main thread
        setTimeout(() => {
          fetch("https://api.ipify.org?format=json")
            .then(response => response.json())
            .then(data => {
              const ip = data.ip;
              const userAgent = navigator.userAgent;
              const trackingUrl = `${GCLID_URL}?gclid=${gclid}&ip=${ip}&ua=${encodeURIComponent(userAgent)}`;
              
              fetch(trackingUrl)
                .catch(error => console.error('GCLID tracking failed:', error));
            })
            .catch(error => console.error('IP fetch failed:', error));
        }, 1000);
      }
    }

    // ========== FORM SUBMISSION ==========
    
    async function submitToSheets(formData) {
      const response = await fetch(SHEETS_URL, {
        method: 'POST',
        body: new URLSearchParams(formData)
      });
      
      const responseText = await response.text();
      return {
        ok: response.ok,
        status: response.status,
        body: tryParseJSON(responseText)
      };
    }

    async function submitToEmailWithFallback(payload, formData) {
      // Try JSON POST first
      try {
        const response = await fetch(EMAIL_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          credentials: 'omit'
        });
        
        const responseText = await response.text();
        return {
          method: 'json',
          ok: response.ok,
          status: response.status,
          body: tryParseJSON(responseText)
        };
      } catch (error) {
        // JSON POST failed, try form-encoded fallback
        try {
          const response = await fetch(EMAIL_URL, {
            method: 'POST',
            body: new URLSearchParams(formData)
          });
          
          const responseText = await response.text();
          return {
            method: 'form',
            ok: response.ok,
            status: response.status,
            body: tryParseJSON(responseText)
          };
        } catch (fallbackError) {
          return {
            method: 'none',
            ok: false,
            error: String(fallbackError)
          };
        }
      }
    }

    // ========== FORM VALIDATION ==========
    
    function validateForm(formValues) {
      if (!formValues.name || !formValues.phone) {
        return 'Name and phone are required';
      }
      
      const normalizedPhone = normalizePhone(formValues.phone);
      if (normalizedPhone.length < 7) {
        return 'Phone number appears to be invalid';
      }
      
      return null; // No errors
    }

    // ========== FORM SUBMISSION HANDLER ==========
    
    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      
      const formData = new FormData(form);
      const formValues = formDataToObject(formData);
      
      // Validate form
      const validationError = validateForm(formValues);
      if (validationError) {
        setResult(validationError, false);
        return;
      }
      
      try {
        // Step 1: Submit to Sheets
        setResult('Submitting to database...', true);
        const sheetsResult = await submitToSheets(formData);
        
        if (!sheetsResult.ok) {
          const errorMessage = typeof sheetsResult.body === 'string' 
            ? sheetsResult.body 
            : JSON.stringify(sheetsResult.body);
          
          setResult('Database submission failed: ' + errorMessage, false);
          return;
        }
        
        // Step 2: Send email notification
        setResult('Database saved — sending notification...', true);
        
        const emailPayload = {
          formType: formValues.formType || 'tv',
          name: formValues.name || '',
          phone: formValues.phone || '',
          tv_type: formValues.tv_type || '',
          issue: formValues.issue || ''
        };
        
        const emailResult = await submitToEmailWithFallback(emailPayload, formData);
        
        if (!emailResult.ok) {
          const errorMessage = emailResult.error || 
            (emailResult.body ? JSON.stringify(emailResult.body) : 'Unknown error');
          
          setResult(`Notification failed (${emailResult.method}): ${errorMessage}`, false);
          
          // Add debugging information
          resultDisplay.textContent += '\n\nDatabase response:\n' + 
            JSON.stringify(sheetsResult.body, null, 2) +
            '\n\nNotification diagnostics:\n' + 
            JSON.stringify(emailResult, null, 2);
          
          return;
        }
        
        // Success
        setResult('Submission complete! We will contact you soon.', true);
        
        // Add response details for debugging
        resultDisplay.textContent += '\n\nDatabase response:\n' + 
          JSON.stringify(sheetsResult.body, null, 2) +
          '\n\nNotification response:\n' + 
          JSON.stringify(emailResult.body, null, 2) +
          '\n\nNotification method: ' + emailResult.method + 
          ' (status ' + emailResult.status + ')';
        
        // Reset form on success
        form.reset();
        
      } catch (error) {
        setResult('Unexpected error: ' + String(error), false);
        console.error('Form submission error:', error);
      }
    });
  </script>
</body>
</html>